<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<th:block layout:fragment="content">
  <style>

    .innerDiv{
      width: 900px;
      display: flex;
      align-items: center;
      min-height: 1000px;
      padding: 15px;
      justify-content: center;
    }

    .input-field {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background-color: #f5f5f5;
      outline: none;
      width: 100%;
      height: 95%;
      font-size: 15px;
    }
    .api-button {
      background-image: url('/assets/img/icon/icon-search.png');
      background-position: center;
      background-size: contain;
      background-repeat: no-repeat;
      background-color: transparent;
      background-size: 25px auto;
      padding: 15px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .custom-input-box {
      background-color: #f5f5f5;
      border: none;
      border-radius: 13px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      width: 850px;
      height: 35px;
      padding: 10px;
      border: 3px solid #ccc;
      transition: border-color 0.3s;
      margin: 20px;
    }

    .postSelect {
      font-size: 17px;
      color: gray; /* Lighter color for unselected text */
      cursor: pointer; /* Change cursor to pointer on hover */
    }
    .postSelect.selected {
      color: white; /* Darker color for selected text */
      font-weight: bold; /* Add bold style to selected text */
    }
    #selectOptions{
      margin: 10px;

    }
    .listDiv{
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      background: #31313c;
      border-radius: 10px;
    }
    .infoBar{
      width: 100%;
      height: 40px;
      display: flex;
      justify-content: space-between;
      background: #2c2c2f;
      align-items: center;
      margin: 0px 0px 10px 0px;
      padding: 0px 40px 0px 40px;
      font-weight: bold;
      border-top-right-radius: 10px;
      border-top-left-radius: 10px;
    }
    .custom-link {
      text-decoration: none; /* 밑줄 제거 */
      color: white; /* 링크 색상 설정 */
      cursor: pointer; /* 커서 스타일 변경 (선택 사항) */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-left: 10px;
    }
    .custom-input-box2 {
      background-color: #f5f5f5;
      border: none;
      border-radius: 13px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      width: 150px;
      height: 35px;
      border: 3px solid #ccc;
      transition: border-color 0.3s;
    }
    .postingColumn{
      max-width: 805px;
    }
    .postingColumn:hover{
      background-color: #363640;
    }
    .listtab{
      display: flex;
      align-items: center;
      min-height: 721px;
    }

    .pidN{
      min-width: 100px;
      max-width: 100px;
      font-weight: bold;
      font-size: 16px;
      color: gray;
      text-align: center;
      line-height: 60px;
    }
    .categoryN{
      min-width: 55px;
      max-width: 55px;
      font-weight: bold;
      font-size: 18px;
      text-align: center;
      line-height: 60px;
    }
    .titleN{
      min-width: 350px;
      max-width: 350px;
    }
    .titleNText{
      font-weight: bold;
      font-size: 20px;
      text-align: left;
      line-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    .lookN{
      min-width: 100px;
      max-width: 100px;
      font-weight: bold;
      font-size: 20px;
      text-align: center;
      line-height: 60px;
      margin-left: 100px;
    }
    .likeN{
      min-width: 100px;
      max-width: 100px;
      font-weight: bold;
      font-size: 20px;
      text-align: center;
      line-height: 60px;
    }

    #pagingController{
      width: 320px;
      height: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px;
    }
    #pageNumbers{
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-width: 200px;
    }
    #pageNumbers > div {
      display: flex;
      justify-content: center;
      align-items: center;
      flex: 1; /* 남은 공간을 모두 차지하도록 설정 */
    }

    .pageLinkBtn{
      font-size: 20px;
      text-decoration-line: none;
      color: gray;
    }
    .current-page{
      color: white;
    }
    .moveBtn{
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }


    .selectBox {
      width: 130px; /* 선택 상자의 너비를 조정합니다. */
      margin: 10px; /* 선택 상자 주위의 여백을 조정합니다. */
    }


    .select {
      width: 100%;
      padding: 8px; /* 선택 상자의 패딩을 조정합니다. */
      font-size: 14px; /* 글꼴 크기를 조정합니다. */
      border: 1px solid #ccc; /* 테두리 스타일을 지정합니다. */
      background-color: #f5f5f5;
      border-radius: 13px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }
    .select:hover{
      cursor: pointer;
    }
    #searchField{
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .writeBtn{
      border: white solid 2px;
      border-radius: 5px;
      padding: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      float: right;
    }
    .writeBtn:hover{
      cursor: pointer;
      scale: 1.05;
    }

    .postingBox{
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      border: 2px solid #DADFD7;
      border-radius: 10px;
      margin-bottom: 20px;
      padding: 15px 0 15px 0;
    }
    .postingBox>div{
      width: 90%;
    }
    #infoCategory{
      border: 2px solid steelblue;
      border-radius: 3px;
      padding: 3px;
    }
    .titleBox{
      font-weight: bold;
      font-size: 26px;
      align-items: center;
      text-align: left;
      margin: 10px 0 10px 0;
    }
    .infoBox{
      display: flex;
      align-items: center;
      justify-content: left;
      margin: 15px;
    }
    .infoImg{
      width: 30px;
      filter: invert(80%);
      margin-right: 7px;
    }
    .infoText{
      color: lightgray;
      font-size: 20px;
    }
    .contentBox{
      margin: 20px;
      font-size: 23px;
    }
    .likeBox{
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .cIpunt{
      border: 3px solid #343536;
      border-radius: 10px;
      background-color: #2c2d30;
      align-items: center;
    }
    .commentInput {
      border: none;
      background: transparent;
      outline: none;
      width: 95%;
      height: 80px;
      margin: 10px;
      text-indent: 0;
      color: white;
    }
    .commentEditBox {
      border: none;
      background: transparent;
      outline: none;
      color: white;
      font-size: 18px;
      resize: none;
    }
    .commentEditBox2 {
      color: black;
      font-size: 18px;
      resize: none;
    }
    .commentBtn{
      cursor: pointer;
      width: 80px;
      height: 30px;
      color: cornflowerblue;
      font-weight: bold;
      background: rgba(46, 82, 180, 0.7);;
      border-radius: 5px;
      font-size: 20px;
      text-align: center;
      margin: 5px;
    }
    .commentCounter{
      margin-left: 15px;
    }
    .commentBox{
      display: flex;
      width: 100%;
      justify-content: center;
      align-items: center;
      margin-top: 25px;
      margin-bottom: 50px;
    }
    .optBtn{
      background: #1c1c1f;
    }

  </style>

  <div class="main-box bg-dark">

    <div>
      <label class="custom-input-box">
        <input type="text" id="inputValue" class="input-field" placeholder="라이엇 ID와 태그를 입력해주세요. ( ex. Hide on bush #KR1 )" onkeydown="handleEnterKey(event)" onclick="highlightInput()">
        <div onclick="callApi()" class="api-button"></div>
      </label>
    </div>

    <div class="row-lo innerDiv">
      <div class="column-lo">
        <div>
          <div class="column-lo postingBox">
            <div class="titleBox" id="titleBox"></div>
            <div class="row-lo infoBox">
              <div style="color: steelblue" id="infoCategory"></div>
              <div class="infoText" id="infoWriter" style="margin-left: 10px;"></div>
              <div class="row-lo" style="margin-left: 10px;">
                <img style="width: 30px; filter: invert(90%); margin-right: 7px;" src="assets/img/icon/look.png">
                <div class="infoText" id="infoLook"></div>
              </div>
              <div class="row-lo" style="margin-left: 10px;">
                <img class="infoImg" src="assets/img/icon/comment.png">
                <div class="infoText" id="infoComment"></div>
              </div>
              <div class="row-lo" style="margin-left: 10px;">
                <img class="infoImg" src="assets/img/icon/like.png">
                <div class="infoText" id="infoLike"></div>
              </div>
              <div style="cursor: pointer; margin-left: auto;" onclick="commentOption(event,0,0,'post')"><img style="width: 25px;" src="assets/img/icon/option.png"></div>
            </div>
            <div style="border: 1px solid #212f3c; height: 1px;"></div>
            <div class="contentBox" id="contentBox"></div>
            <div style="border: 1px solid #212f3c; height: 1px;"></div>
            <div class="row-lo likeBox">
              <div class="row-lo" style="border: 3px solid #3254CE; border-radius: 5px; padding: 7px; margin: 10px;" onclick="likeBtn()">
                <div><img style="width: 40px;" src="assets/img/icon/likeBtn.png"></div>
                <div style="font-size: 30px; margin-left: 10px;" id="likeCount"></div>
              </div>
            </div>
          </div>
          <div class="column-lo cIpunt" id="commentInputT">
            <div style="width: 100%; display: flex; justify-content: center; align-items: center">
              <textarea class="commentInput" id="commentText" placeholder="댓글을 입력하세요." oninput="checkLength()"></textarea>
            </div>
            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center">
              <div class="commentCounter" id="commentCounter">0 / 255</div>
              <div class="commentBtn" onclick="uploadComment()">
                등록
              </div>
            </div>


          </div>
          <div class="column-lo cIpunt" id="commentInputF" onclick="checkLogin()">
            <div style="width: 100%; display: flex; justify-content: center; align-items: center">
              <textarea class="commentInput" placeholder="로그인이 필요합니다." readonly></textarea>
            </div>
          </div>

          <div class="column-lo commentBox" id="commentListBox"></div>


          <div class="row-lo" style="display: flex; justify-content: space-between; width: 100%; height: 45px; margin-bottom: 5px;">
            <div class="row-lo" id="selectOptions">
              <div class="postSelect" id="recentPost">최신순</div>
              <div>&nbsp;&nbsp;|&nbsp;&nbsp;</div>
              <div class="postSelect" id="hotPost">인기순</div>
            </div>
            <div class="row-lo" id="searchField">
              <div class="selectBox">
                <select name="category" class="select" id="searchType">
                  <option value="1">제목</option>
                  <option value="2">제목+내용</option>
                </select>
              </div>
              <div>
                <label class="custom-input-box2">
                  <input type="text" id="keyword" name="keyword" class="input-field" placeholder="게시물 검색">
                  <div onclick="search()" class="api-button"></div>
                </label>
              </div>
            </div>
          </div>
          <div class="column-lo listDiv">
            <div class="row-lo infoBar">
              <div style="min-width: 100px; text-align: center;">번호</div>
              <div style="min-width: 55px; text-align: center;">분류</div>
              <div style="min-width: 350px; text-align: center;">제목</div>
              <div style="min-width: 100px; text-align: center; margin-left: 100px;">조회</div>
              <div style="min-width: 100px; text-align: center;">추천</div>
            </div>
            <div class="column-lo" style="display: none; position: absolute; width: 90%;" id="noPostingTab">
              <div style="font-weight: bold;font-size: 20px; margin: 15px; text-align: center;">검색 내용에 일치하는 게시물이 없습니다!</div>
              <div style="font-weight: bold;font-size: 17px; margin: 10px; text-align: center;">검색 내용을 확인해주세요.</div>
            </div>
            <div class="column-lo" id="postingList" style="width: 100%;">
            </div>
            <div class="row-lo" style="display: flex;justify-content: space-between;align-items: center; width: 90%;">
              <div style="width: 107.5px;"></div>
              <div id="pagingController">
                <div class="moveBtn" onclick="previousPage()"><img src="assets/img/icon/left.png" style="width: 100%; height: auto"></div>
                <div id="pageNumbers"></div>
                <div class="moveBtn" onclick="nextPage()"><img src="assets/img/icon/right.png" style="width: 100%; height: auto"></div>
              </div>
              <div class="row-lo writeBtn" onclick="newPosting()">
                <img src="assets/img/icon/post.png" style="filter: invert(100%); width: 25px;">
                <div class="custom-link" style="font-size: 20px;">글쓰기</div>
              </div>
            </div>
          </div>
        </div>

      </div>


    </div>
  </div>


  <script>
    let currentPage  = 1;
    let totalPages;
    let select = 1;
    let ppp = 10;
    let postData;
    let posting;
    let thisPid = null;
    let commentLen;

    // 페이지가 로드되면 실행되는 함수
    document.addEventListener("DOMContentLoaded", async function() {

      if (getLoginStatus()){
        document.getElementById("commentInputT").style.display = "block";
        document.getElementById("commentInputF").style.display = "none";
      }else {
        document.getElementById("commentInputT").style.display = "none";
        document.getElementById("commentInputF").style.display = "block";
      }

      // 현재 URL 가져오기
      var posturl = window.location.href;

      // URL에서 pid 값 추출
      var pidIndex = posturl.indexOf('pid=');

      if (pidIndex !== -1) {
        // 'pid='이 발견되면 값을 추출
        thisPid = posturl.substring(pidIndex + 4);

        var data = await getPost(thisPid);
        posting = data[0]

      } else {
        console.log('URL에서 pid 값을 찾을 수 없습니다.');
      }

      postData = await callPosting(0,"");
      await generateComment();
      inputPostingData()
      totalPages = Math.ceil(postData.length/ppp);


      await generatePosting(currentPage);
      updatePageNumbers();
    });

    function inputPostingData(){
      var title = document.getElementById("titleBox");
      title.innerText = posting[0]["title"];

      var category = document.getElementById("infoCategory");
      if (posting[0]["category"] == 1){
        category.innerText = "잡담"
      }else if (posting["category"] == 2){
        category.innerText = "질문"
      }else if (posting["category"] == 3){
        category.innerText = "공략"
      }
      var infoWriter = document.getElementById("infoWriter");
      infoWriter.innerText = posting[1]["email"];

      var infoLook = document.getElementById("infoLook");
      infoLook.innerText = posting[0]["look"];

      var infoComment = document.getElementById("infoComment");
      infoComment.innerText = commentLen;

      var infoLike = document.getElementById("infoLike");
      infoLike.innerText = posting[0]["like_count"];

      var likeCount = document.getElementById("likeCount");
      likeCount.innerText = posting[0]["like_count"];

      var content = document.getElementById("contentBox");
      content.innerText = posting[0]['content'];

    }



    //조회수 증가
    function titleBtn(pid){
      if(lookCounting(pid)){
        window.location.href = `/post?pid=${pid}`;
      }
      else{
        alert("오류가 발생했습니다!\n다시 시도해주세요");
      }
    }
    const lookCounting = async (pid) => {
      try {
        const response = await fetch(apiUrl + "/lookCount", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ pid: pid})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }
    //좋아요 업데이트
    async function likeBtn() {
      var userEmail = getLoginUser();
      if (userEmail) {
        try {
          var likeCount = await likeCounting(thisPid, userEmail);

          if (likeCount !== undefined) {
            var infoLike = document.getElementById("infoLike");
            infoLike.innerText = likeCount;

            var likeCountElement = document.getElementById("likeCount");
            likeCountElement.innerText = likeCount;
          } else {
            alert("오류가 발생했습니다!\n다시 시도해주세요");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("오류가 발생했습니다!\n다시 시도해주세요");
        }
      } else {
        checkLogin();
      }
    }
    const likeCounting = async (pid,email) => {
      try {
        const response = await fetch(apiUrl + "/likeCount", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ pid: pid,email:email})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }
    //댓글 입력
    const uploadCommenttoServer = async (text,userEmail,pid) => {
      try {
        const response = await fetch(apiUrl + "/uploadCommenttoServer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ text: text,email:userEmail,pid:pid})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }

    //댓글 생성
    async function generateComment(){
      var data = await getComment(thisPid);
      var commentListBox = document.getElementById("commentListBox");
      commentLen = data.length;

      const comments = [];

      for (let i = 0; i < data.length; i++) {
        if (i === 0) {
          comments.push(`<div style="border: 1px solid #212f3c; height: 1px; width: 100%;"></div>`);
        }

        comments.push(`
          <div class="column-lo" style="width: 100%; padding: 20px;">
            <div class="row-lo" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
              <div class="row-lo">
                <div style="font-weight: bold; font-size: 15px;">${data[i][1]["email"]}</div>
              </div>
              <div style="cursor: pointer;" onclick="commentOption(event,'${data[i][0]['commentId']}', '${data[i][1]['email']}','comment')"><img style="width: 25px;" src="assets/img/icon/option.png"></div>
            </div>
            <div class="column-lo">
              <textarea class="commentEditBox" id="commentEditBox${data[i][0]['commentId']}" readonly oninput="checkLength2(${data[i][0]['commentId']})">${data[i][0]["text"]}</textarea>
            </div>
            <div style="width: 100%; display: none; justify-content: space-between; align-items: center;" id="editInfo">
              <div class="commentCounter" id="commentCounter${data[i][0]['commentId']}">0 / 255</div>
              <div class="commentBtn" onclick="uploadEditComment(${data[i][0]['commentId']})">
                등록
              </div>
            </div>
          </div>
          <div style="border: 1px solid #212f3c; height: 1px; width: 100%;"></div>
        `);
      }

      // Now you can append the generated HTML to the commentListBox or any other element
      commentListBox.innerHTML = comments.join('');
    }
    //댓글 작성 길이 제한
    function checkLength() {
      var textarea = document.querySelector('.commentInput');
      var counter = document.getElementById('commentCounter');

      var maxLength = 255;
      var currentLength = textarea.value.length;

      if (currentLength > maxLength) {
        // Trim the text if it exceeds the limit
        textarea.value = textarea.value.substring(0, maxLength);
        currentLength = maxLength;
      }

      counter.textContent = currentLength + ' / ' + maxLength;
    }
    function checkLength2(cid) {
      var textarea = document.getElementById(`commentEditBox${cid}`);
      var counter = document.getElementById(`commentCounter${cid}`);

      var maxLength = 255;
      var currentLength = textarea.value.length;

      if (currentLength > maxLength) {
        // Trim the text if it exceeds the limit
        textarea.value = textarea.value.substring(0, maxLength);
        currentLength = maxLength;
      }

      counter.textContent = currentLength + ' / ' + maxLength;
    }
    //댓글 입력
    const getComment = async (pid) => {
      try {
        const response = await fetch(apiUrl + "/getComment", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({pid:pid})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }
    //옵션창 생성
    function commentOption(event,cid,email,optDiv) {
      const mX = event.clientX + window.pageXOffset;
      const mY = event.clientY + window.pageYOffset;

      const opt = document.createElement("div");
      if (optDiv == "comment"){
        opt.innerHTML = `
            <div class="row-lo optBtn" style="width: 120px; display:flex; align-items: center; justify-content: center; border-radius: 10px; border: 2px solid gray">
                <div style="margin: 5px; cursor: pointer;" class="option-btn" onclick="editComment('${cid}','${email}')">수정</div>
                <div style="margin: 5px">|</div>
                <div style="margin: 5px; cursor: pointer" class="option-btn" onclick="deleteComment('${cid}','${email}')">삭제</div>
            </div>
        `;
      }
      else if (optDiv == "post"){
        opt.innerHTML = `
            <div class="row-lo optBtn" style="width: 120px; display:flex; align-items: center; justify-content: center; border-radius: 10px; border: 2px solid gray">
                <div style="margin: 5px; cursor: pointer;" class="option-btn" onclick="editPost()">수정</div>
                <div style="margin: 5px">|</div>
                <div style="margin: 5px; cursor: pointer" class="option-btn" onclick="deletePost()">삭제</div>
            </div>
        `;
      }

      // Set the position of the speech bubble
      opt.style.position = "absolute";
      opt.style.left = mX + "px";
      opt.style.top = mY + "px";


      document.body.appendChild(opt);

      setTimeout(() => {
        // Add a click event listener to the document
        const clickOutsideListener = function (e) {
          // Check if the clicked element is not the option bubble or its child
          if (e.target !== opt && !opt.contains(e.target)) {
            // Remove the option bubble
            document.body.removeChild(opt);

            // Remove the click event listener after the option bubble is removed
            document.removeEventListener("click", clickOutsideListener);
          }
        };

        // Add the click event listener to the document
        document.addEventListener("click", clickOutsideListener);
      }, 0);
    }
    //댓글 수정
    function editComment(cid, email){
      var userEmail = getLoginUser()

      if (!userEmail){
        checkLogin();
      }
      else{
        if (userEmail == email){
          // 사용자가 확인을 누르면 true 반환, 취소하면 false 반환
          var shouldEdit = window.confirm("댓글을 수정하시겠습니까?");

          // 사용자가 확인을 눌렀을 때
          if (shouldEdit) {
            document.getElementById("editInfo").style.display = "flex";
            var textArea = document.getElementById(`commentEditBox${cid}`);
            textArea.removeAttribute("readonly");
            textArea.classList.remove("commentEditBox");
            textArea.classList.add("commentEditBox2");
            checkLength2(cid);
          }
        }else {
          alert("작성자만 수정할 수 있습니다!")
        }
      }
    }
    function uploadEditComment(cid){
      var text = document.getElementById(`commentEditBox${cid}`).value;
      if (callEditComment(cid,text)){
        window.location.href = window.location.href;
      }else {
        alert("오류가 발생했습니다.\n다시 시도해주세요.")
      }

    }
    const callEditComment = async (cid,text) => {
      try {
        const response = await fetch(apiUrl + "/editComment", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ cid: cid,text:text})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }
    //댓글 삭제
    function deleteComment(cid, email){
      var userEmail = getLoginUser()

      if (!userEmail){
        checkLogin();
      }else{
        if (userEmail == email){
          // 사용자가 확인을 누르면 true 반환, 취소하면 false 반환
          var shouldDelete = window.confirm("댓글을 삭제하시겠습니까?\n이 작업은 취소할 수 없습니다.");

          // 사용자가 확인을 눌렀을 때
          if (shouldDelete) {
            if (callDeleteComment(cid,userEmail)){
              window.location.href = window.location.href;
            }else {
              alert("오류가 발생했습니다.\n다시 시도해주세요.")
            }

          }
        }else {
          alert("작성자만 삭제할 수 있습니다!")
        }
      }
    }
    const callDeleteComment = async (cid,email) => {
      try {
        const response = await fetch(apiUrl + "/deleteComment", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ cid: cid,email:email})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }
    //댓글 수
    const getCommentcount = async (pid) => {
      try {
        const response = await fetch(apiUrl + "/getCommentcount", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ pid: pid})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }

    //게시글 수정
    async function editPost(){
      var userEmail = getLoginUser();

      if (!userEmail){
        checkLogin();
      }
      else{
        var shouldEdit = window.confirm("게시글을 수정하시겠습니까?");

        // 사용자가 확인을 눌렀을 때
        if (shouldEdit) {
          var check = await callWriter(thisPid);
          console.log(check)

          if (check==userEmail){
            var newUrl = "/newPosting?pid="+thisPid;
            window.location.href = newUrl;
          }else if(check=="false"){
            alert("오류가 발생햇습니다!\n다시 시도해주세요.")
          }else if (check!=userEmail){
            alert("작성자만 수정할 수 있습니다!")
          }
        }
      }
    }
    //게시글 삭제
    async function deletePost(){
      var userEmail = getLoginUser()
      if (!userEmail){
        checkLogin();
      }else {
        var shouldEdit = window.confirm("게시글을 삭제하시겠습니까?");

        // 사용자가 확인을 눌렀을 때
        if (shouldEdit) {
          var result = await callDeletePost(thisPid,userEmail);

          console.log(result);
          if (result=="true"){
            alert("삭제를 완료하였습니다!")
            window.location.href = "/community";
          }else if (result=="false"){
            alert("오류가 발생했습니다.\n다시 시도해주세요.")
          }else if (result=="false2"){
            alert("작성자만 삭제할 수 있습니다!")
          }
        }

      }
    }
    const callDeletePost = async (pid,email) => {
      try {
        const response = await fetch(apiUrl + "/deletePost", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ pid: pid,email:email})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.text();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }

    async function generatePosting(page) {
      if (postData.length<1){
        document.getElementById("noPostingTab").style.display = "block";
      }else {
        document.getElementById("noPostingTab").style.display = "none";
      }
      document.getElementById("postingList").innerHTML = "";
      const postingList = document.createElement("div");
      postingList.classList.add("column-lo")
      postingList.classList.add("listtab")


      postingList.innerHTML=`
        ${await generateList(page)}
    `;

      document.getElementById("postingList").appendChild(postingList);

    }
    async function generateList(page) {
      const rList = [];
      const pageSize = 10;  // 페이지당 아이템 수
      const startIndex = (page - 1) * pageSize;
      let endIndex = startIndex + pageSize;

      let pageData;

      // 마지막 페이지 처리: 데이터 개수가 pageSize의 배수가 아닐 때
      if (endIndex > postData.length) {
        endIndex = postData.length;
      }
      pageData = postData.slice(startIndex, endIndex);

      for (let i = 0;i<pageData.length;i++){

        var commentCount = await getCommentcount(pageData[i]["postId"])
        if (i==0){
          rList.push(`
            <div style="width: 90%; height: 1px; margin: 5px; background: gray;"></div>
        `);
        }

        let category;
        if (pageData[i]["category"] == 1){
          category = "잡담";
        }
        else if (pageData[i]["category"] == 2){
          category = "질문";
        }
        else if (pageData[i]["category"] == 3){
          category = "공략";
        }
        rList.push(`
            <div class="row-lo postingColumn" style="display:flex; justify-content: space-between; width: 100%; height: 60px;">
                <div class="pidN">${pageData[i]["postId"]}</div>
                <div class="categoryN">${category}</div>
                <div class="row-lo titleN" onclick="titleBtn(${pageData[i]['postId']})">
                    <div class="titleNText" style="max-width: 250px;">${pageData[i]["title"]}</div>
                    <div class="titleNText" style="margin-left: 20px; color: lightskyblue">(&nbsp;${commentCount}&nbsp;)</div>
                </div>
                <div class="lookN">${pageData[i]["look"]}</div>
                <div class="likeN">${pageData[i]["like_count"]}</div>
            </div>
        `);

        rList.push(`
            <div style="width: 90%; height: 1px; margin: 5px; background: gray;"></div>
        `);

      }

      return rList.join('');
    }
    async function search() {
      var searchType = document.getElementById("searchType").value;
      var keyword = document.getElementById("keyword").value;

      // 실제 검색 로직을 여기에 추가하세요.
      postData = await callPosting(searchType,keyword);
      if (recentPost.classList.contains("selected")){
        postData.sort((a, b) => b.postId - a.postId);
      }
      else {
        postData.sort((a, b) => b.like_count - a.like_count);
      }

      generatePosting(currentPage);
      totalPages = Math.ceil(postData.length/ppp);
      updatePageNumbers();
    }

    const getPost = async (pid) => {
      try {
        const response = await fetch(apiUrl + "/getPost", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ pid: pid})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }
    //게시글 정보 요청
    const callPosting = async (category,keyword) => {
      try {
        const response = await fetch(apiUrl + "/searchPosting", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ category: category,keyword:keyword})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }

    function uploadComment(){
      var text = document.getElementById("commentText").value;
      var userEmail = getLoginUser()
      if (!userEmail){
        checkLogin();
      }else {
        if (uploadCommenttoServer(text,userEmail,thisPid)){
          window.location.href = window.location.href;
        }else{
          alert("오류가 발생했습니다.\n다시 시도해주세요.")
        }
      }

    }

    function newPosting(){
      var user = getLoginUser();

      if (!user){
        checkLogin();
      }else{
        window.location.href = "/newPosting"
      }
    }
    //페이지 관련 함수
    function updatePageNumbers() {
      const pageNumbersElement = document.getElementById("pageNumbers");
      pageNumbersElement.classList.add("row-lo");
      pageNumbersElement.classList.add("pageNumbersElement");
      pageNumbersElement.innerHTML = "";


      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(startPage + 4, totalPages);

      for (let i = startPage; i <= endPage; i++) {
        const divElement = document.createElement("div");

        const pageNumberLink = document.createElement("a");
        pageNumberLink.href = "#";
        pageNumberLink.textContent = i;
        pageNumberLink.onclick = () => changePage(i);
        pageNumberLink.classList.add("pageLinkBtn")


        if (i === currentPage) {
          pageNumberLink.classList.add("current-page");
        }

        // div 안에 링크 추가
        divElement.appendChild(pageNumberLink);

        // div를 페이지 요소에 추가
        pageNumbersElement.appendChild(divElement);

      }
    }
    function changePage(page) {
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        const newUrl = window.location.href.split('?')[0] + `?page=${page}`;
        window.history.pushState({ path: newUrl }, '', newUrl);
        if (select == 1){
          generatePosting(page,1);
        }
        else if (select == 2){
          generatePosting(page,2);
        }
        updatePageNumbers();
      }
    }
    function previousPage() {
      if (currentPage > 1) {
        changePage(currentPage - 1);
      }
    }
    function nextPage() {
      if (currentPage < totalPages) {
        changePage(currentPage + 1);
      }
    }

    recentPost.classList.add("selected");

    // Event listeners
    recentPost.addEventListener("click", () => {
      select =1;
      currentPage = 1;
      totalPages = Math.ceil(postData.length/ppp);
      recentPost.classList.add("selected");
      hotPost.classList.remove("selected");

      postData.sort((a, b) => b.postId - a.postId);
      generatePosting(currentPage);
      updatePageNumbers();
    });
    hotPost.addEventListener("click", () => {
      select =2;
      currentPage = 1;
      totalPages = Math.ceil(postData.length/ppp);
      hotPost.classList.add("selected");
      recentPost.classList.remove("selected");

      postData.sort((a, b) => b.like_count - a.like_count);
      generatePosting(currentPage);
      updatePageNumbers();
    });

    //소환사 검색 함수
    function highlightInput() {
      const inputLabel = document.querySelector('.custom-input-box');
      inputLabel.style.borderColor = '#007bff';
    }
    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        callApi();
      }
    }
    document.addEventListener('click', function(event) {
      const inputLabel = document.querySelector('.custom-input-box');
      if (!inputLabel.contains(event.target)) {
        inputLabel.style.borderColor = '#1c1c1f';
      }
    });

    const callWriter = async (pid) => {
      try {
        const response = await fetch(apiUrl + "/checkWriter", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ pid: pid})
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.text();
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }
    //소환사 페이지로 이동
    function callApi() {
      const inputValue = document.getElementById('inputValue').value;

      if (inputValue) {
        // 입력값을 컨트롤러로 전달하고 페이지 이동
        window.location.href = `/info?summonerName=${encodeURIComponent(inputValue)}`;
      }
    }
  </script>

</th:block>


</html>